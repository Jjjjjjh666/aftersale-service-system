<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ControllerAspect.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.javaee.core.aop</a> &gt; <span class="el_source">ControllerAspect.java</span></div><h1>ControllerAspect.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.javaee.core.aop;

import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.ReturnObject;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import java.time.LocalDateTime;

import static cn.edu.xmu.javaee.core.model.Constants.BEGIN_TIME;
import static cn.edu.xmu.javaee.core.model.Constants.END_TIME;

/**
 * 用于控制器方面的Aspect
 */
@Aspect
@Component
@Order(10)
<span class="nc" id="L32">public class ControllerAspect {</span>
<span class="nc" id="L33">    private final Logger logger = LoggerFactory.getLogger(ControllerAspect.class);</span>

    @Value(&quot;${oomall.core.page-size.max}&quot;)
    private int max_page_size;

    @Value(&quot;${oomall.core.page-size.default}&quot;)
    private int default_page_size;

    /**
     * 所有返回值为ReturnObject的Controller
     *
     * @param jp
     * @return
     * @throws Throwable
     */
    @Around(&quot;cn.edu.xmu.javaee.core.aop.CommonPointCuts.controllers()&quot;)
    public Object doAround(ProceedingJoinPoint jp) throws Throwable {
<span class="nc" id="L50">        ReturnObject retVal = null;</span>

<span class="nc" id="L52">        MethodSignature ms = (MethodSignature) jp.getSignature();</span>
<span class="nc" id="L53">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span>
<span class="nc" id="L54">        HttpServletResponse response = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();</span>

<span class="nc" id="L56">        String[] paramNames = ms.getParameterNames();</span>
<span class="nc" id="L57">        logger.debug(&quot;doAround: method = {}, paramNames = {}&quot;, ms.getName(), paramNames);</span>
<span class="nc" id="L58">        Object[] args = jp.getArgs();</span>
        try {
<span class="nc" id="L60">            Object[] newArgs = checkPageTimeLimit(request, paramNames, args);</span>
<span class="nc" id="L61">            retVal = (ReturnObject) jp.proceed(newArgs);</span>
<span class="nc" id="L62">        } catch (BusinessException exception) {</span>
<span class="nc" id="L63">            logger.info(&quot;doAround: BusinessException， errno = {}&quot;, exception.getErrno());</span>
<span class="nc" id="L64">            retVal = new ReturnObject(exception.getErrno(), exception.getMessage());</span>
<span class="nc" id="L65">        }</span>

<span class="nc" id="L67">        ReturnNo code = retVal.getCode();</span>
<span class="nc" id="L68">        logger.debug(&quot;doAround: jp = {}, code = {}&quot;, jp.getSignature().getName(), code);</span>
<span class="nc" id="L69">        response.setStatus(code.getHttpStatus());</span>
<span class="nc" id="L70">        return retVal;</span>
    }

    /**
     * 设置默认的page = 1和pageSize = 10
     * 防止客户端发过来pagesize过大的请求
     *
     * @author maguoqi
     *
     * @param request
     * @param paramNames
     * @param args
     */
    private Object[] checkPageTimeLimit(HttpServletRequest request, String[] paramNames, Object[] args) {
<span class="nc" id="L84">        Integer page = 1, pageSize = default_page_size;</span>
<span class="nc" id="L85">        LocalDateTime beginTime = BEGIN_TIME, endTime = END_TIME;</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (request != null) {</span>

<span class="nc" id="L89">            String pageString = request.getParameter(&quot;page&quot;);</span>
<span class="nc" id="L90">            String pageSizeString = request.getParameter(&quot;pageSize&quot;);</span>
<span class="nc" id="L91">            String beginTimeString = request.getParameter(&quot;beginTime&quot;);</span>
<span class="nc" id="L92">            String endTimeString = request.getParameter(&quot;endTime&quot;);</span>

<span class="nc bnc" id="L94" title="All 6 branches missed.">            if (null != pageString &amp;&amp; !pageString.isEmpty() &amp;&amp; pageString.matches(&quot;\\d+&quot;)) {</span>
<span class="nc" id="L95">                page = Integer.valueOf(pageString);</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                if (page &lt;= 0) {</span>
<span class="nc" id="L97">                    page = 1;</span>
                }
            }

<span class="nc bnc" id="L101" title="All 6 branches missed.">            if (null != pageSizeString &amp;&amp; !pageSizeString.isEmpty() &amp;&amp; pageSizeString.matches(&quot;\\d+&quot;)) {</span>
<span class="nc" id="L102">                pageSize = Integer.valueOf(pageSizeString);</span>
<span class="nc bnc" id="L103" title="All 4 branches missed.">                if (pageSize &lt;= 0 || pageSize &gt; max_page_size) {</span>
<span class="nc" id="L104">                    pageSize = default_page_size;</span>
                }
            }

            try {
<span class="nc bnc" id="L109" title="All 8 branches missed.">                if (null != beginTimeString &amp;&amp; null != endTimeString &amp;&amp; !beginTimeString.isEmpty() &amp;&amp; !endTimeString.isEmpty()) {</span>
<span class="nc" id="L110">                    beginTime = LocalDateTime.parse(beginTimeString);</span>
<span class="nc" id="L111">                    endTime = LocalDateTime.parse(endTimeString);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    if (beginTime.isAfter(endTime)) {</span>
<span class="nc" id="L113">                        beginTime = BEGIN_TIME;</span>
<span class="nc" id="L114">                        endTime = END_TIME;</span>
                    }
                }
<span class="nc" id="L117">            } catch (Exception e) {</span>
<span class="nc" id="L118">                logger.debug(&quot;Exception occurs in time checking: {}&quot;, e.getMessage());</span>
<span class="nc" id="L119">            }</span>
        }

<span class="nc bnc" id="L122" title="All 2 branches missed.">        for (int i = 0; i &lt; paramNames.length; i++) {</span>
<span class="nc" id="L123">            logger.debug(&quot;checkPageTimeLimit: paramNames[{}] = {}&quot;, i, paramNames[i]);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">            if (paramNames[i].equals(&quot;page&quot;)) {</span>
<span class="nc" id="L125">                logger.debug(&quot;checkPageTimeLimit: set {} to {}&quot;,paramNames[i], page);</span>
<span class="nc" id="L126">                args[i] = page;</span>
<span class="nc" id="L127">                continue;</span>
            }

<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (paramNames[i].equals(&quot;pageSize&quot;)) {</span>
<span class="nc" id="L131">                logger.debug(&quot;checkPageTimeLimit: set {} to {}&quot;,paramNames[i], pageSize);</span>
<span class="nc" id="L132">                args[i] = pageSize;</span>
<span class="nc" id="L133">                continue;</span>
            }

<span class="nc bnc" id="L136" title="All 4 branches missed.">            if (paramNames[i].equals(&quot;beginTime&quot;) &amp;&amp; (args[i] == null)){</span>
<span class="nc" id="L137">                logger.debug(&quot;checkPageTimeLimit: set {} to {}&quot;,paramNames[i], BEGIN_TIME);</span>
<span class="nc" id="L138">                args[i] = beginTime;</span>
<span class="nc" id="L139">                continue;</span>
            }

<span class="nc bnc" id="L142" title="All 4 branches missed.">            if (paramNames[i].equals(&quot;endTime&quot;) &amp;&amp; (args[i] == null)){</span>
<span class="nc" id="L143">                logger.debug(&quot;checkPageTimeLimit: set {} to {}&quot;,paramNames[i], END_TIME);</span>
<span class="nc" id="L144">                args[i] = endTime;</span>
            }
        }
<span class="nc" id="L147">        return args;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>